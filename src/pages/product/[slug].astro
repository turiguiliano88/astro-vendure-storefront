---
import Base from '../../layouts/base.astro';
import { getProducts, getActiveOrder, getActiveCustomer } from '../../api/server';
// import App from '../../components/App';
import App from '../../components/product';

export async function getStaticPaths() {
    const data = await getProducts(100);
    return data.products.items.map(item => {
        return {
            params: {
                slug: item.slug
            },
            props: {
                product: item
            }
        }
    })

}

const cookie = Astro.request.headers.get('cookie');
let totalQuantity, customerName;
if (cookie) {
	totalQuantity = (await getActiveOrder(cookie)).activeOrder?.totalQuantity;
	const activeCustomer = (await getActiveCustomer(cookie)).activeCustomer;
	if (activeCustomer) customerName = activeCustomer?.firstName + ' ' + activeCustomer?.lastName;
}
const {slug} = Astro.params;
const {product} = Astro.props;

// console.log('param', Astro.params)
// const url = new URL(Astro.request.url);
// const token = url.searchParams.get('auth_token');

// const order = (await getActiveOrder(token)).activeOrder
---

<Base title="product">
<App client:load product={product} customerName={customerName} totalQuantity={totalQuantity} />
</Base>